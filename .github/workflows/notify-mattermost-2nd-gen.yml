name: Notify Mattermost 2nd gen

on:
  workflow_call:
    inputs:
      commit:
        description: "The commit used by the github checkout action. Default: github.sha"
        type: string
        default: ${{ github.sha }}
      exit-with-status:
        description: "Exit this job/workflow with the monitored job status. Options: true or false. Default: true"
        type: string
        default: "true"
      highlight:
        description: "Mattermost highlight. Default: channel"
        type: string
        default: "channel"
      status:
        description: "The monitored job, job status."
        type: string
        required: true
      channel:
        description: "The name of the channel where the notification happens."
        type: string
        default: pd2ndgendeployment
      shortline:
        description: "Mattermost use shortline mode. Default: true"
        type: string
        default: "true"
      # New inputs
      product:
        description: "Product name (asset, lookout, detect, management-console, security-intelligence, enterprise-containers)"
        type: string
        required: false
      stage:
        description: "Deployment stage (dev, integration, testing, staging, production)"
        type: string
        required: false
      version:
        description: "Product or service version (semver format, e.g., 1.15.1-alpha.10)"
        type: string
        required: false
      service:
        description: "Service name for service-update notifications"
        type: string
        required: false
      from-stage:
        description: "Source stage for stage-transition notifications (e.g., testing)"
        type: string
        required: false
      to-stage:
        description: "Target stage for stage-transition notifications (e.g., staging)"
        type: string
        required: false
      notification-type:
        description: "Type of notification (deployment, service-update, stage-transition, release, hotfix)"
        type: string
        required: false
      changed-services:
        description: "Comma-separated list of changed services"
        type: string
        required: false
    # Dependabot don't have this secrets and on PR's this secrets are not needed.
    secrets:
      MATTERMOST_WEBHOOK_URL:
        required: false

jobs:
  notify-mattermost:
    runs-on: self-hosted-generic
    if: ${{ !cancelled() }}
    steps:
      - name: Notify Mattermost 2nd gen
        uses: greenbone/actions/mattermost-notify@v3
        with:
          url: ${{ secrets.MATTERMOST_WEBHOOK_URL }}
          channel: ${{ inputs.channel }}
          highlight: ${{ inputs.highlight }}
          branch: ${{ github.ref_name }}
          commit: ${{ inputs.commit }}
          workflow: ${{ github.run_id }}
          workflow-name: ${{ github.workflow }}
          status: ${{ inputs.status }}
          shortline: ${{ inputs.shortline }}
          product: ${{ inputs.product }}
          stage: ${{ inputs.stage }}
          version: ${{ inputs.version }}
          service: ${{ inputs.service }}
          from-stage: ${{ inputs.from-stage }}
          to-stage: ${{ inputs.to-stage }}
          notification-type: ${{ inputs.notification-type }}
          changed-services: ${{ inputs.changed-services }}

      - name: Exit with monitored job status
        if: inputs.exit-with-status == 'true' && inputs.status != 'success'
        run: |
          echo "Monitored job failed. Exit job/workflow with failure"
          exit 1
